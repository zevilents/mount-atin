-- LocalScript: SimplePath GUI runner
-- Pastikan ModuleScript SimplePath ada di ReplicatedStorage dengan nama "SimplePath"

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer

-- Ganti koordinat sesuai daftar kamu
local POS2 = Vector3.new(-184, 128, 408)
local POS3 = Vector3.new(-166, 229, 652)

-- Parent GUI: pakai gethui jika ada (executor), fallback CoreGui
local parentGui = (gethui and gethui()) or game:GetService("CoreGui")

-- cari module SimplePath
local function getPathModule()
	local ok, mod = pcall(function() return ReplicatedStorage:WaitForChild("SimplePath", 2) end)
	if ok and mod and mod:IsA("ModuleScript") then
		local success, required = pcall(require, mod)
		if success and required then
			return required
		else
			warn("[SimplePathGUI] Gagal require SimplePath:", required)
			return nil
		end
	end
	warn("[SimplePathGUI] Module SimplePath tidak ditemukan di ReplicatedStorage")
	return nil
end

local PathModule = getPathModule()

-- jika modul tidak ada, hentikan lebih awal (agar tidak error)
if not PathModule then
	-- buat GUI informatif agar user tahu modul belum tersedia
	if parentGui:FindFirstChild("SimplePathGuiMissing") then parentGui.SimplePathGuiMissing:Destroy() end
	local g = Instance.new("ScreenGui")
	g.Name = "SimplePathGuiMissing"
	g.Parent = parentGui
	local t = Instance.new("TextLabel")
	t.Size = UDim2.new(0,400,0,60)
	t.Position = UDim2.new(0.5,-200,0.5,-30)
	t.BackgroundTransparency = 0.3
	t.Text = "SimplePath module not found in ReplicatedStorage.\nPlace ModuleScript 'SimplePath' into ReplicatedStorage."
	t.TextWrapped = true
	t.TextColor3 = Color3.new(1,1,1)
	t.Parent = g
	return
end

-- GUI create (hapus bila ada)
if parentGui:FindFirstChild("SimplePathGui") then
	parentGui.SimplePathGui:Destroy()
end

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "SimplePathGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = parentGui

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0,260,0,110)
frame.Position = UDim2.new(0.5,-130,0.78,0)
frame.BackgroundTransparency = 0.25
frame.Parent = screenGui

local uic = Instance.new("UICorner", frame)
uic.CornerRadius = UDim.new(0,8)

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -16, 0, 28)
title.Position = UDim2.new(0,8,0,6)
title.Text = "SimplePath Runner"
title.BackgroundTransparency = 1
title.TextColor3 = Color3.new(1,1,1)
title.Font = Enum.Font.SourceSansBold
title.TextSize = 18
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = frame

local info = Instance.new("TextLabel")
info.Size = UDim2.new(1, -16, 0, 34)
info.Position = UDim2.new(0,8,0,34)
info.Text = "Klik tombol untuk teleport ke POS2 lalu jalankan SimplePath ke POS3"
info.BackgroundTransparency = 1
info.TextColor3 = Color3.new(1,1,1)
info.TextWrapped = true
info.TextSize = 14
info.Font = Enum.Font.SourceSans
info.Parent = frame

local btn = Instance.new("TextButton")
btn.Size = UDim2.new(0,220,0,32)
btn.Position = UDim2.new(0,20,0,74)
btn.Text = "Jalan POS2 → POS3 (SimplePath)"
btn.Parent = frame
btn.Font = Enum.Font.SourceSansBold
btn.TextSize = 14
btn.BackgroundColor3 = Color3.fromRGB(60,130,200)
btn.TextColor3 = Color3.new(1,1,1)
btn.AutoButtonColor = true
local btnCorner = Instance.new("UICorner", btn)
btnCorner.CornerRadius = UDim.new(0,6)

-- helper: buat Path object untuk karakter saat ini
local function makePathForCharacter(character)
	if not character then return nil end
	if not character.PrimaryPart then
		-- tunggu PrimaryPart kalau belum ada
		character:GetPropertyChangedSignal("PrimaryPart"):Wait()
		if not character.PrimaryPart then return nil end
	end
	local ok, pathObj = pcall(function()
		return PathModule.new(character, {
			AgentHeight = 5,
			AgentRadius = 2,
			AgentCanJump = true,
			AgentJumpHeight = 10,
			AgentMaxSlope = 45
		})
	end)
	if ok and pathObj then
		-- aktifkan visual
		pathObj.Visualize = true
		return pathObj
	else
		warn("[SimplePathGUI] Gagal inisialisasi Path:", pathObj)
		return nil
	end
end

-- simpan Path per karakter
local currentPath = nil

-- buat / rekreate path saat karakter spawn / respawn
local function setupForCharacter(character)
	-- bersihkan Path lama
	if currentPath then
		pcall(function() currentPath:Destroy() end)
		currentPath = nil
	end

	-- delay sedikit agar humanoid & primarypart siap
	character:WaitForChild("Humanoid", 5)
	character:WaitForChild("HumanoidRootPart", 5)

	local p = makePathForCharacter(character)
	if not p then
		warn("[SimplePathGUI] Tidak bisa buat Path untuk karakter.")
		return
	end

	-- event feedback
	p.Reached:Connect(function(agent, waypoint)
		-- waypoint arg mungkin table; tampilkan ke UI
		print("[SimplePathGUI] Reached target.")
		btn.Text = "Selesai (Reached)"
		task.delay(2, function() if btn then btn.Text = "Jalan POS2 → POS3 (SimplePath)" end end)
	end)
	p.Error:Connect(function(errType)
		print("[SimplePathGUI] Path Error:", errType)
		btn.Text = "Error: "..tostring(errType)
		task.delay(3, function() if btn then btn.Text = "Jalan POS2 → POS3 (SimplePath)" end end)
	end)
	p.WaypointReached:Connect(function(agent, lastWaypoint, nextWaypoint)
		-- debug masing2 waypoint
		-- print("[SimplePathGUI] WaypointReached ->", lastWaypoint.Position, "->", nextWaypoint.Position)
	end)

	currentPath = p
end

-- inisialisasi untuk existing character
if player.Character then
	setupForCharacter(player.Character)
end

-- reconnect saat respawn
player.CharacterAdded:Connect(function(char)
	-- tunggu sebentar lalu setup
	task.wait(0.5)
	setupForCharacter(char)
end)

-- fungsi utama: teleport ke POS2 lalu run ke POS3
local function runSimplePath()
	if not currentPath then
		-- coba buat ulang jika belum ada
		if player.Character then
			setupForCharacter(player.Character)
			if not currentPath then
				warn("[SimplePathGUI] currentPath masih nil, abort.")
				return
			end
		else
			warn("[SimplePathGUI] Player.Character nil")
			return
		end
	end

	local char = player.Character
	if not char or not char.PrimaryPart then
		warn("[SimplePathGUI] Karakter belum siap")
		return
	end

	-- teleport ke POS2 (menggunakan PivotTo agar lebih aman)
	pcall(function()
		char:PivotTo(CFrame.new(POS2))
	end)

	-- beri waktu settle
	task.wait(0.8)

	-- jalankan path ke POS3
	btn.Text = "Running..."
	local ok, res = pcall(function()
		return currentPath:Run(POS3)
	end)
	if not ok or not res then
		warn("[SimplePathGUI] Path:Run returned false or error. res:", res)
		btn.Text = "Path gagal"
		task.delay(2, function() if btn then btn.Text = "Jalan POS2 → POS3 (SimplePath)" end end)
	else
		print("[SimplePathGUI] Path:Run() dipanggil.")
	end
end

btn.MouseButton1Click:Connect(function()
	-- disable tombol sementara
	btn.Active = false
	btn.AutoButtonColor = false
	pcall(runSimplePath)
	btn.Active = true
	btn.AutoButtonColor = true
end)

print("[SimplePathGUI] Ready. Module SimplePath used from ReplicatedStorage.")
